<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TikTok 多像素批量激活 · 新版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="description" content="批量激活多个 TikTok Pixel 的 Register / Purchase 等事件，支持并行、批量上传、历史记录与CSV导出。">
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <div class="max-w-5xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-bold">TikTok 多像素批量激活</h1>
      <div class="text-sm text-slate-500">仅供被授权的广告账户运维使用</div>
    </header>

    <!-- Stats -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="rounded-2xl bg-white p-4 shadow">
        <div class="text-xs text-slate-500">总像素</div>
        <div id="stat-total" class="text-2xl font-semibold">0</div>
      </div>
      <div class="rounded-2xl bg-white p-4 shadow">
        <div class="text-xs text-slate-500">已激活</div>
        <div id="stat-success" class="text-2xl font-semibold">0</div>
      </div>
      <div class="rounded-2xl bg-white p-4 shadow">
        <div class="text-xs text-slate-500">失败</div>
        <div id="stat-fail" class="text-2xl font-semibold">0</div>
      </div>
      <div class="rounded-2xl bg-white p-4 shadow">
        <div class="text-xs text-slate-500">成功率</div>
        <div id="stat-rate" class="text-2xl font-semibold">0%</div>
      </div>
    </section>

    <!-- Config -->
    <section class="rounded-2xl bg-white p-5 shadow space-y-4">
      <h2 class="font-semibold text-lg">配置</h2>

      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm mb-1">Pixel IDs（用逗号分隔）</label>
          <input id="pixelIds" class="w-full rounded-xl border p-2" placeholder="1234567890, 9876543210" />
        </div>
        <div>
          <label class="block text-sm mb-1">激活链接（每行一个）</label>
          <textarea id="activateLinks" class="w-full rounded-xl border p-2 h-24" placeholder="https://..."></textarea>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-3">
        <label class="inline-flex items-center gap-2 text-sm">
          <input id="autoExtract" type="checkbox" class="h-4 w-4" checked />
          从链接自动提取 Pixel ID
        </label>
        <label class="inline-flex items-center gap-2 text-sm">
          <input id="parallel" type="number" min="1" max="20" value="6" class="h-8 w-20 rounded border p-1 text-center" />
          并发数
        </label>
        <label class="inline-flex items-center gap-2 text-sm">
          事件类型
          <select id="eventType" class="rounded border p-1 h-8">
            <option value="Register" selected>Register</option>
            <option value="Purchase">Purchase</option>
            <!-- 未来可扩展：ViewContent, AddToCart, CompletePayment -->
          </select>
        </label>
        <input id="fileInput" type="file" accept=".txt" class="hidden" />
        <button id="btnUpload" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-sm">批量上传 .txt</button>
      </div>

      <div class="flex gap-3">
        <button id="btnActivate" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white">激活所有</button>
        <button id="btnReset" class="px-4 py-2 rounded-xl bg-slate-200 hover:bg-slate-300">重置</button>
        <button id="btnExport" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white">导出CSV</button>
        <div id="status" class="text-sm text-slate-500 self-center">状态：待命</div>
      </div>
    </section>

    <!-- Results table -->
    <section class="rounded-2xl bg-white p-5 shadow space-y-3">
      <h2 class="font-semibold text-lg">结果</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-slate-500">
              <th class="py-2 pr-4">时间</th>
              <th class="py-2 pr-4">Pixel ID</th>
              <th class="py-2 pr-4">事件</th>
              <th class="py-2 pr-4">状态</th>
              <th class="py-2 pr-4">说明</th>
            </tr>
          </thead>
          <tbody id="resultBody"></tbody>
        </table>
      </div>
    </section>

    <!-- History -->
    <section class="rounded-2xl bg-white p-5 shadow space-y-3">
      <h2 class="font-semibold text-lg">历史记录（本地）</h2>
      <div id="history" class="text-sm text-slate-600">暂无记录</div>
      <button id="btnClearHistory" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200 text-sm">清空历史</button>
    </section>

    <footer class="py-8 text-center text-xs text-slate-500">
      © <span id="brandYear"></span> 你的品牌名 · TikTok Pixel Utility · 仅供内部运维
    </footer>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const stat = { total:0, success:0, fail:0 };
  const logs = []; // [{time,id,event,status,msg}]
  const HISTORY_KEY = 'tt-activator-history-v1';

  const updateStats = ()=>{
    $('stat-total').textContent = stat.total;
    $('stat-success').textContent = stat.success;
    $('stat-fail').textContent = stat.fail;
    const rate = stat.total ? Math.round(stat.success / (stat.success+stat.fail) * 100) : 0;
    $('stat-rate').textContent = rate + '%';
  };

  const addRow = (time, id, event, status, msg)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="py-2 pr-4 whitespace-nowrap">${time}</td>
      <td class="py-2 pr-4">${id || '-'}</td>
      <td class="py-2 pr-4">${event}</td>
      <td class="py-2 pr-4">${status}</td>
      <td class="py-2 pr-4">${msg || ''}</td>`;
    $('resultBody').prepend(tr);
  };

  const saveHistory = ()=>{
    const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    const entry = { ts: Date.now(), count: stat.total, success: stat.success, fail: stat.fail };
    history.unshift(entry);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0,50)));
    renderHistory();
  };

  const renderHistory = ()=>{
    const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
    if(history.length === 0){ $('history').textContent = '暂无记录'; return; }
    $('history').innerHTML = history.map(h=>{
      const d = new Date(h.ts);
      return `<div class="py-1">[${d.toLocaleString()}] 批次：${h.count}，成功：${h.success}，失败：${h.fail}</div>`;
    }).join('');
  };

  const parseInput = ()=>{
    const ids = ($('pixelIds').value || '')
      .split(',')
      .map(s=>s.trim())
      .filter(Boolean);

    const links = ($('activateLinks').value || '')
      .split('\n')
      .map(s=>s.trim())
      .filter(Boolean);

    let extractedIds = [];
    if ($('autoExtract').checked) {
      for(const u of links){
        const m = u.match(/pixel_id=([0-9]+)/i);
        if(m) extractedIds.push(m[1]);
      }
    }
    const allIds = [...new Set([...ids, ...extractedIds])];
    return { allIds, links };
  };

  // 模拟激活：优先使用 sendBeacon，其次 image ping，再次 fetch(no-cors)
  const firePixel = (pixelId, eventType)=>{
    return new Promise((resolve)=>{
      const ts = Date.now();
      // 这是示意URL：真实路径依据你的激活链接/格式调整
      // 例如官方像素脚本里经常会走像素上报端点，具体以你的“激活链接”模板为准。
      const url = `https://analytics.tiktok.com/i18n/pixel/activate?pixel_id=${encodeURIComponent(pixelId)}&event=${encodeURIComponent(eventType)}&ts=${ts}`;

      let done = false;
      const finish = (ok, msg)=>{
        if(done) return; done = true;
        resolve({ ok, msg });
      };

      // 尝试 sendBeacon
      try{
        const ok = navigator.sendBeacon(url);
        if(ok) return finish(true, 'sendBeacon');
      }catch(e){ /* ignore */ }

      // 尝试 image ping
      try{
        const img = new Image();
        img.onload = ()=>finish(true, 'image');
        img.onerror = ()=>finish(false, 'image-error');
        img.src = url + '&_=' + Math.random();
        // 给 3 秒超时
        setTimeout(()=>finish(true, 'image-timeout-assumed'), 3000);
        return;
      }catch(e){ /* ignore */ }

      // 退化 fetch no-cors
      try{
        fetch(url, { mode: 'no-cors' })
          .then(()=>finish(true, 'fetch-nocors'))
          .catch(()=>finish(false, 'fetch-error'));
      }catch(e){
        finish(false, 'exception');
      }
    });
  };

  const pLimit = (limit, arr, iteratorFn)=>{
    const ret = [];
    const executing = new Set();
    for(const item of arr){
      const p = Promise.resolve().then(()=>iteratorFn(item));
      ret.push(p);
      executing.add(p);
      const clean = ()=>executing.delete(p);
      p.then(clean).catch(clean);
      if(executing.size >= limit){
        await Promise.race(executing);
      }
    }
    return Promise.all(ret);
  };

  // 由于 pLimit 用到了 await/race，这里将其改为异步函数写法
})();
</script>
<script>
(async function(){
  const $ = (id)=>document.getElementById(id);
  const statusEl = $('status');
  const stats = { total:0, success:0, fail:0 };
  const updateStats = ()=>{
    $('stat-total').textContent = stats.total;
    $('stat-success').textContent = stats.success;
    $('stat-fail').textContent = stats.fail;
    const rate = (stats.success + stats.fail) ? Math.round(stats.success/(stats.success+stats.fail)*100) : 0;
    $('stat-rate').textContent = rate + '%';
  };

  const addRow = (row)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="py-2 pr-4 whitespace-nowrap">${new Date().toLocaleString()}</td>
      <td class="py-2 pr-4">${row.id || '-'}</td>
      <td class="py-2 pr-4">${row.event}</td>
      <td class="py-2 pr-4">${row.ok ? '成功' : '失败'}</td>
      <td class="py-2 pr-4">${row.msg || ''}</td>
    `;
    document.getElementById('resultBody').prepend(tr);
  };

  const saveHistory = ()=>{
    const key='tt-activator-history-v1';
    const list = JSON.parse(localStorage.getItem(key) || '[]');
    list.unshift({ ts: Date.now(), total: stats.total, success: stats.success, fail: stats.fail });
    localStorage.setItem(key, JSON.stringify(list.slice(0,50)));
    renderHistory();
  };

  const renderHistory = ()=>{
    const key='tt-activator-history-v1';
    const list = JSON.parse(localStorage.getItem(key) || '[]');
    const box = document.getElementById('history');
    if(list.length===0){ box.textContent='暂无记录'; return; }
    box.innerHTML = list.map(x=>{
      const d = new Date(x.ts).toLocaleString();
      return `<div class="py-1">[${d}] 批次:${x.total} 成功:${x.success} 失败:${x.fail}</div>`;
    }).join('');
  };

  function parseInput(){
    const idsInput = document.getElementById('pixelIds').value.trim();
    const linksInput = document.getElementById('activateLinks').value.trim();
    const autoExtract = document.getElementById('autoExtract').checked;

    const ids = idsInput ? idsInput.split(',').map(s=>s.trim()).filter(Boolean) : [];
    const links = linksInput ? linksInput.split('\n').map(s=>s.trim()).filter(Boolean) : [];

    let extracted = [];
    if(autoExtract){
      for(const u of links){
        const m = u.match(/pixel_id=([0-9]+)/i);
        if(m) extracted.push(m[1]);
      }
    }
    return Array.from(new Set([...ids, ...extracted]));
  }

  function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

  async function firePixel(pixelId, eventType){
    const ts = Date.now();
    const url = `https://analytics.tiktok.com/i18n/pixel/activate?pixel_id=${encodeURIComponent(pixelId)}&event=${encodeURIComponent(eventType)}&ts=${ts}`;

    // 1) sendBeacon
    try{
      if(navigator.sendBeacon && navigator.sendBeacon(url)){
        return { ok:true, msg:'sendBeacon' };
      }
    }catch(e){}

    // 2) image ping + 2.5s 超时
    try{
      await new Promise((resolve,reject)=>{
        const img = new Image();
        let settled = false;
        const finish = (ok,msg)=>{ if(settled) return; settled=true; ok?resolve(msg):reject(new Error(msg)); };
        img.onload = ()=>finish(true,'image');
        img.onerror = ()=>finish(false,'image-error');
        img.src = url + '&_=' + Math.random();
        setTimeout(()=>finish(true,'image-timeout-assumed'), 2500);
      });
      return { ok:true, msg:'image' };
    }catch(e){}

    // 3) fetch no-cors 兜底
    try{
      await fetch(url, { mode:'no-cors' });
      return { ok:true, msg:'fetch-nocors' };
    }catch(e){
      return { ok:false, msg:'fetch-error' };
    }
  }

  async function runBatch(ids, eventType, concurrency){
    const queue = [...ids];
    const workers = new Array(Math.min(concurrency, queue.length)).fill(0).map(()=>worker());
    async function worker(){
      while(queue.length){
        const id = queue.shift();
        statusEl.textContent = `状态：激活 ${id} 中...（剩余 ${queue.length}）`;
        const res = await firePixel(id, eventType);
        if(res.ok) stats.success++; else stats.fail++;
        stats.total++;
        updateStats();
        addRow({ id, event:eventType, ok:res.ok, msg:res.msg });
        await sleep(120); // 轻微节流
      }
    }
    await Promise.all(workers);
  }

  document.getElementById('btnUpload').addEventListener('click', ()=>document.getElementById('fileInput').click());
  document.getElementById('fileInput').addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if(!file) return;
    const text = await file.text();
    const lines = text.split('\n').map(s=>s.trim()).filter(Boolean);
    // 智能识别：既可能是ID也可能是链接
    const ids = [];
    for(const line of lines){
      if(/^[0-9]+$/.test(line)) ids.push(line);
      const m = line.match(/pixel_id=([0-9]+)/i);
      if(m) ids.push(m[1]);
    }
    const uniq = Array.from(new Set(ids));
    const existIds = document.getElementById('pixelIds').value.trim();
    document.getElementById('pixelIds').value = (existIds ? existIds + ', ' : '') + uniq.join(', ');
  });

  document.getElementById('btnActivate').addEventListener('click', async ()=>{
    const ids = parseInput();
    const eventType = document.getElementById('eventType').value;
    const concurrency = Math.max(1, Math.min(20, parseInt(document.getElementById('parallel').value||'6', 10)));

    if(ids.length === 0){
      alert('请至少提供一个 Pixel ID 或激活链接'); return;
    }
    // reset stats in UI
    stats.total = 0; stats.success = 0; stats.fail = 0; updateStats();
    document.getElementById('resultBody').innerHTML = '';

    statusEl.textContent = '状态：开始并行激活...';
    await runBatch(ids, eventType, concurrency);
    statusEl.textContent = '状态：完成';
    saveHistory();
  });

  document.getElementById('btnReset').addEventListener('click', ()=>{
    document.getElementById('pixelIds').value = '';
    document.getElementById('activateLinks').value = '';
    statusEl.textContent = '状态：已重置';
  });

  document.getElementById('btnExport').addEventListener('click', ()=>{
    const rows = Array.from(document.querySelectorAll('#resultBody tr')).reverse().map(tr=>{
      const tds = tr.querySelectorAll('td');
      return [tds[0].textContent, tds[1].textContent, tds[2].textContent, tds[3].textContent, tds[4].textContent];
    });
    const header = ['时间','Pixel ID','事件','状态','说明'];
    const csv = [header, ...rows].map(r=>r.map(x=>`"${(x||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `tiktok_pixel_logs_${Date.now()}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  document.getElementById('btnClearHistory').addEventListener('click', ()=>{
    localStorage.removeItem('tt-activator-history-v1');
    renderHistory();
  });

  document.getElementById('brandYear').textContent = new Date().getFullYear();
  renderHistory();
})();
</script>
</body>
</html>
