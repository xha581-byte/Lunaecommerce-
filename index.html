<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Mobile Pixel Event Tester</title>
  <style>
    :root { --gap: 14px; --radius: 14px; --shadow: 0 8px 24px rgba(0,0,0,.08); --border: #ececec; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, system-ui, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Noto Sans CJK SC", sans-serif; background:#fafafa; color:#222; }
    header { position: sticky; top: 0; background: #fff; padding: 12px var(--gap); border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; z-index: 10; }
    header input { flex: 1; height: 44px; border:1px solid var(--border); border-radius: 10px; padding: 0 12px; }
    header button { height: 44px; padding: 0 14px; border: 0; border-radius: 10px; background: #222; color:#fff; }
    main { padding: var(--gap); max-width: 760px; margin: 0 auto; }
    .card { background:#fff; border:1px solid var(--border); border-radius: var(--radius); padding: var(--gap); box-shadow: var(--shadow); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--gap); }
    .stack { display: grid; gap: 10px; }
    label { font-size: 13px; opacity: .8; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="number"], select {
      width: 100%; height: 44px; border:1px solid var(--border); border-radius: 10px; padding: 0 12px;
    }
    .btn { width: 100%; height: 48px; border:0; border-radius: 12px; background:#111; color:#fff; font-weight: 600; }
    .btn.secondary { background:#f2f2f2; color:#111; border:1px solid var(--border); }
    .grid { display:grid; gap: var(--gap); }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius: 999px; border:1px solid var(--border); background:#fff; font-size: 12px; }
    .log { max-height: 300px; overflow:auto; font-family: ui-monospace, Menlo, Consolas, monospace; background:#0b1220; color:#d4f2ff; padding: var(--gap); border-radius: var(--radius); }
    .log .line { padding: 6px 0; border-bottom: 1px dashed rgba(255,255,255,.08); }
    .footer { margin-top: 16px; font-size: 12px; opacity:.7; }
  </style>
  <!-- Meta Pixel Code -->
  <script>
    // è§£æ URL å‚æ•°
    function getQuery(name) {
      const m = new RegExp('[?&]'+name+'=([^&#]*)').exec(location.search);
      return m ? decodeURIComponent(m[1].replace(/\+/g, ' ')) : '';
    }

    // ç®€å•æ—¥å¿—
    function log(msg, data) {
      const box = document.getElementById('eventLog');
      const line = document.createElement('div');
      line.className = 'line';
      const time = new Date().toLocaleTimeString();
      let json = '';
      try { json = data ? ' ' + JSON.stringify(data) : ''; } catch(e){}
      line.textContent = `[${time}] ${msg}${json}`;
      box.prepend(line);
    }

    // ç”Ÿæˆä¸€ä¸ªç›¸å¯¹å”¯ä¸€çš„äº‹ä»¶IDï¼ˆä¾¿äºäº‹ä»¶å»é‡/æ’æŸ¥ï¼‰
    function genEventId(prefix='evt') {
      return `${prefix}_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
    }

    // åˆå§‹åŒ– Pixel
    function initPixel(pixelId, advancedMatch) {
      if (!pixelId) {
        log('âš ï¸ è¯·å…ˆå¡«å…¥ Pixel ID');
        return;
      }
      // æ ‡å‡† Meta Pixel ä»£ç 
      !(function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
      n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)})(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');

      if (advancedMatch && (advancedMatch.em || advancedMatch.ph)) {
        // ä¼ å…¥æœªå“ˆå¸Œçš„ em / phï¼Œåƒç´ ä¼šåœ¨å‘é€å‰è‡ªåŠ¨åš SHA-256
        fbq('init', pixelId, advancedMatch);
        log('âœ… Pixel å·²åˆå§‹åŒ–ï¼ˆå« Advanced Matchingï¼‰', advancedMatch);
      } else {
        fbq('init', pixelId);
        log('âœ… Pixel å·²åˆå§‹åŒ–', { pixelId });
      }
      fbq('track', 'PageView', {eventID: genEventId('pageview')});
      log('ğŸ“© è§¦å‘ PageView');
      document.getElementById('statusPill').innerText = 'Connected: ' + pixelId;
      localStorage.setItem('pixel_id', pixelId);
    }

    // è§¦å‘äº‹ä»¶
    function fire(eventName, params={}, isCustom=false) {
      const method = isCustom ? 'trackCustom' : 'track';
      const withId = Object.assign({eventID: genEventId(eventName)}, params || {});
      fbq(method, eventName, withId);
      log(`ğŸ¯ ${isCustom ? 'trackCustom' : 'track'} â†’ ${eventName}`, withId);
    }

    // é¡µé¢åŠ è½½åå¤„ç†
    document.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('pixel_id') || '';
      const fromQuery = getQuery('pid');
      const pixel = fromQuery || saved || 'PIXEL_ID_REPLACE_ME';
      document.getElementById('pixelId').value = pixel === 'PIXEL_ID_REPLACE_ME' ? '' : pixel;

      // è‡ªåŠ¨åˆå§‹åŒ–ï¼ˆå¦‚æœ URL æˆ–æœ¬åœ°å·²æœ‰åƒç´ ï¼‰
      if (pixel && pixel !== 'PIXEL_ID_REPLACE_ME') {
        initPixel(pixel);
      }

      // ç»‘å®šæŒ‰é’®
      document.getElementById('applyPixel').addEventListener('click', () => {
        initPixel(document.getElementById('pixelId').value.trim());
      });

      document.getElementById('applyAM').addEventListener('click', () => {
        const pixelId = document.getElementById('pixelId').value.trim();
        const em = document.getElementById('em').value.trim();
        const ph = document.getElementById('ph').value.trim();
        initPixel(pixelId, { em: em || undefined, ph: ph || undefined });
      });

      document.getElementById('btnViewContent').addEventListener('click', () => {
        fire('ViewContent', {content_name:'Demo Product', content_ids:['SKU-001'], content_type:'product'});
      });

      document.getElementById('btnAddToCart').addEventListener('click', () => {
        fire('AddToCart', {content_ids:['SKU-001'], content_type:'product', value: 19.9, currency: document.getElementById('ccy').value});
      });

      document.getElementById('btnInitiateCheckout').addEventListener('click', () => {
        fire('InitiateCheckout', {num_items:1, value: 19.9, currency: document.getElementById('ccy').value});
      });

      document.getElementById('btnLead').addEventListener('click', () => {
        const em = document.getElementById('em').value.trim();
        fire('Lead', em ? { em } : {});
      });

      document.getElementById('btnPurchase').addEventListener('click', () => {
        const val = parseFloat(document.getElementById('amount').value || '29.9');
        fire('Purchase', {value: isNaN(val) ? 29.9 : val, currency: document.getElementById('ccy').value});
      });

      document.getElementById('btnCustomActivation').addEventListener('click', () => {
        fire('Activation', {source:'mobile-test'}, true);
      });

      document.getElementById('btnContact').addEventListener('click', () => {
        fire('Contact', {method:'whatsapp'});
      });

      document.getElementById('btnSubscribe').addEventListener('click', () => {
        fire('Subscribe', {plan:'basic'});
      });

      document.getElementById('btnSearch').addEventListener('click', () => {
        fire('Search', {search_string:'æµ‹è¯•å…³é”®è¯'});
      });
    });
  </script>
  <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=PIXEL_ID_REPLACE_ME&ev=PageView&noscript=1"
  /></noscript>
</head>
<body>
  <header>
    <span class="pill" id="statusPill">Not connected</span>
    <input id="pixelId" type="text" inputmode="numeric" placeholder="è¾“å…¥ä½ çš„ Pixel IDï¼ˆæˆ–ç”¨ ?pid=xxx æ‰“å¼€ï¼‰" />
    <button id="applyPixel">è¿æ¥åƒç´ </button>
  </header>

  <main class="grid">
    <section class="card stack">
      <h2 style="margin:0;">å¸¸ç”¨äº‹ä»¶ï¼ˆé€‚é…ç§»åŠ¨ç«¯ï¼‰</h2>
      <div class="row">
        <button class="btn" id="btnViewContent">ViewContent</button>
        <button class="btn" id="btnAddToCart">AddToCart</button>
      </div>
      <div class="row">
        <button class="btn" id="btnInitiateCheckout">InitiateCheckout</button>
        <button class="btn" id="btnLead">Lead</button>
      </div>
      <div class="row">
        <button class="btn" id="btnPurchase">Purchase</button>
        <button class="btn secondary" id="btnCustomActivation">è‡ªå®šä¹‰ï¼šActivation</button>
      </div>
    </section>

    <section class="card stack">
      <h3 style="margin:0;">äº‹ä»¶å‚æ•°ï¼ˆå¯é€‰ï¼‰</h3>
      <div class="row">
        <div>
          <label for="amount">é‡‘é¢ï¼ˆç”¨äº Purchaseï¼‰</label>
          <input id="amount" type="number" step="0.01" placeholder="ä¾‹å¦‚ 29.90" />
        </div>
        <div>
          <label for="ccy">å¸ç§</label>
          <select id="ccy">
            <option value="MYR" selected>MYR</option>
            <option value="USD">USD</option>
            <option value="SGD">SGD</option>
            <option value="THB">THB</option>
            <option value="VND">VND</option>
            <option value="IDR">IDR</option>
          </select>
        </div>
      </div>
    </section>

    <section class="card stack">
      <h3 style="margin:0;">Advanced Matchingï¼ˆå¯é€‰ï¼‰</h3>
      <div class="row">
        <div>
          <label for="em">é‚®ç®± em</label>
          <input id="em" type="email" placeholder="name@example.com" />
        </div>
        <div>
          <label for="ph">æ‰‹æœºå· phï¼ˆä»…æ•°å­—ï¼Œå«å›½å®¶ç ï¼‰</label>
          <input id="ph" type="tel" inputmode="numeric" placeholder="60123456789" />
        </div>
      </div>
      <button class="btn" id="applyAM">åº”ç”¨é«˜çº§åŒ¹é…</button>
      <p class="footer">æç¤ºï¼šè¿™é‡Œä¼ å…¥æœªå“ˆå¸Œçš„ em/phï¼Œåƒç´ ä¼šè‡ªåŠ¨åš SHA-256 å†ä¸ŠæŠ¥ã€‚</p>
    </section>

    <section class="card stack">
      <h3 style="margin:0;">å…¶å®ƒå¸¸è§äº‹ä»¶</h3>
      <div class="row">
        <button class="btn secondary" id="btnContact">Contact</button>
        <button class="btn secondary" id="btnSubscribe">Subscribe</button>
      </div>
      <div class="row">
        <button class="btn secondary" id="btnSearch">Search</button>
        <button class="btn secondary" onclick="fire('CompleteRegistration')">CompleteRegistration</button>
      </div>
    </section>

    <section class="card stack">
      <h3 style="margin:0;">äº‹ä»¶æ—¥å¿—</h3>
      <div id="eventLog" class="log" aria-live="polite"></div>
      <div class="footer">åœ¨ Meta Events Manager çš„ã€ŒTest Eventsã€é‡Œä¹Ÿèƒ½çœ‹åˆ°å®æ—¶äº‹ä»¶ã€‚</div>
    </section>

    <section class="card">
      <div class="footer">
        ä»…ç”¨äºæµ‹è¯•/éªŒè¯åƒç´ è§¦å‘ã€‚ä¸Šçº¿æŠ•æ”¾è¯·ç¡®ä¿éšç§æ”¿ç­–ã€Cookie æç¤ºã€åŒæ„ç®¡ç†ç­‰å·²åˆ°ä½ï¼›è‹¥éœ€è¦æœåŠ¡ç«¯ <b>Conversions API</b> å»é‡ä¸æ›´ç¨³çš„å½’å› ï¼Œè¿™ä¸ªé¡µé¢å¯é…åˆä½ ä»¬åç«¯åŠ  CAPIï¼ˆç”¨åŒä¸€ä¸ª <code>eventID</code> åšå»é‡ï¼‰ã€‚
      </div>
    </section>
  </main>
</body>
</html>
