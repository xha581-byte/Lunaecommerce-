<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Mobile Pixel Event Tester</title>
  <style>
    :root { --gap: 14px; --radius: 14px; --shadow: 0 8px 24px rgba(0,0,0,.08); --border: #ececec; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, system-ui, "Segoe UI", Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Noto Sans CJK SC", sans-serif; background:#fafafa; color:#222; }
    header { position: sticky; top: 0; background: #fff; padding: 12px var(--gap); border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; z-index: 10; }
    header input { flex: 1; height: 44px; border:1px solid var(--border); border-radius: 10px; padding: 0 12px; }
    header button { height: 44px; padding: 0 14px; border: 0; border-radius: 10px; background: #222; color:#fff; }
    main { padding: var(--gap); max-width: 760px; margin: 0 auto; }
    .card { background:#fff; border:1px solid var(--border); border-radius: var(--radius); padding: var(--gap); box-shadow: var(--shadow); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--gap); }
    .stack { display: grid; gap: 10px; }
    label { font-size: 13px; opacity: .8; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="number"], select {
      width: 100%; height: 44px; border:1px solid var(--border); border-radius: 10px; padding: 0 12px;
    }
    .btn { width: 100%; height: 48px; border:0; border-radius: 12px; background:#111; color:#fff; font-weight: 600; }
    .btn.secondary { background:#f2f2f2; color:#111; border:1px solid var(--border); }
    .grid { display:grid; gap: var(--gap); }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius: 999px; border:1px solid var(--border); background:#fff; font-size: 12px; }
    .log { max-height: 300px; overflow:auto; font-family: ui-monospace, Menlo, Consolas, monospace; background:#0b1220; color:#d4f2ff; padding: var(--gap); border-radius: var(--radius); }
    .log .line { padding: 6px 0; border-bottom: 1px dashed rgba(255,255,255,.08); }
    .footer { margin-top: 16px; font-size: 12px; opacity:.7; }
  </style>
  <!-- Meta Pixel Code -->
  <script>
    // 解析 URL 参数
    function getQuery(name) {
      const m = new RegExp('[?&]'+name+'=([^&#]*)').exec(location.search);
      return m ? decodeURIComponent(m[1].replace(/\+/g, ' ')) : '';
    }

    // 简单日志
    function log(msg, data) {
      const box = document.getElementById('eventLog');
      const line = document.createElement('div');
      line.className = 'line';
      const time = new Date().toLocaleTimeString();
      let json = '';
      try { json = data ? ' ' + JSON.stringify(data) : ''; } catch(e){}
      line.textContent = `[${time}] ${msg}${json}`;
      box.prepend(line);
    }

    // 生成一个相对唯一的事件ID（便于事件去重/排查）
    function genEventId(prefix='evt') {
      return `${prefix}_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
    }

    // 初始化 Pixel
    function initPixel(pixelId, advancedMatch) {
      if (!pixelId) {
        log('⚠️ 请先填入 Pixel ID');
        return;
      }
      // 标准 Meta Pixel 代码
      !(function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
      n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)})(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');

      if (advancedMatch && (advancedMatch.em || advancedMatch.ph)) {
        // 传入未哈希的 em / ph，像素会在发送前自动做 SHA-256
        fbq('init', pixelId, advancedMatch);
        log('✅ Pixel 已初始化（含 Advanced Matching）', advancedMatch);
      } else {
        fbq('init', pixelId);
        log('✅ Pixel 已初始化', { pixelId });
      }
      fbq('track', 'PageView', {eventID: genEventId('pageview')});
      log('📩 触发 PageView');
      document.getElementById('statusPill').innerText = 'Connected: ' + pixelId;
      localStorage.setItem('pixel_id', pixelId);
    }

    // 触发事件
    function fire(eventName, params={}, isCustom=false) {
      const method = isCustom ? 'trackCustom' : 'track';
      const withId = Object.assign({eventID: genEventId(eventName)}, params || {});
      fbq(method, eventName, withId);
      log(`🎯 ${isCustom ? 'trackCustom' : 'track'} → ${eventName}`, withId);
    }

    // 页面加载后处理
    document.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('pixel_id') || '';
      const fromQuery = getQuery('pid');
      const pixel = fromQuery || saved || 'PIXEL_ID_REPLACE_ME';
      document.getElementById('pixelId').value = pixel === 'PIXEL_ID_REPLACE_ME' ? '' : pixel;

      // 自动初始化（如果 URL 或本地已有像素）
      if (pixel && pixel !== 'PIXEL_ID_REPLACE_ME') {
        initPixel(pixel);
      }

      // 绑定按钮
      document.getElementById('applyPixel').addEventListener('click', () => {
        initPixel(document.getElementById('pixelId').value.trim());
      });

      document.getElementById('applyAM').addEventListener('click', () => {
        const pixelId = document.getElementById('pixelId').value.trim();
        const em = document.getElementById('em').value.trim();
        const ph = document.getElementById('ph').value.trim();
        initPixel(pixelId, { em: em || undefined, ph: ph || undefined });
      });

      document.getElementById('btnViewContent').addEventListener('click', () => {
        fire('ViewContent', {content_name:'Demo Product', content_ids:['SKU-001'], content_type:'product'});
      });

      document.getElementById('btnAddToCart').addEventListener('click', () => {
        fire('AddToCart', {content_ids:['SKU-001'], content_type:'product', value: 19.9, currency: document.getElementById('ccy').value});
      });

      document.getElementById('btnInitiateCheckout').addEventListener('click', () => {
        fire('InitiateCheckout', {num_items:1, value: 19.9, currency: document.getElementById('ccy').value});
      });

      document.getElementById('btnLead').addEventListener('click', () => {
        const em = document.getElementById('em').value.trim();
        fire('Lead', em ? { em } : {});
      });

      document.getElementById('btnPurchase').addEventListener('click', () => {
        const val = parseFloat(document.getElementById('amount').value || '29.9');
        fire('Purchase', {value: isNaN(val) ? 29.9 : val, currency: document.getElementById('ccy').value});
      });

      document.getElementById('btnCustomActivation').addEventListener('click', () => {
        fire('Activation', {source:'mobile-test'}, true);
      });

      document.getElementById('btnContact').addEventListener('click', () => {
        fire('Contact', {method:'whatsapp'});
      });

      document.getElementById('btnSubscribe').addEventListener('click', () => {
        fire('Subscribe', {plan:'basic'});
      });

      document.getElementById('btnSearch').addEventListener('click', () => {
        fire('Search', {search_string:'测试关键词'});
      });
    });
  </script>
  <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=PIXEL_ID_REPLACE_ME&ev=PageView&noscript=1"
  /></noscript>
</head>
<body>
  <header>
    <span class="pill" id="statusPill">Not connected</span>
    <input id="pixelId" type="text" inputmode="numeric" placeholder="输入你的 Pixel ID（或用 ?pid=xxx 打开）" />
    <button id="applyPixel">连接像素</button>
  </header>

  <main class="grid">
    <section class="card stack">
      <h2 style="margin:0;">常用事件（适配移动端）</h2>
      <div class="row">
        <button class="btn" id="btnViewContent">ViewContent</button>
        <button class="btn" id="btnAddToCart">AddToCart</button>
      </div>
      <div class="row">
        <button class="btn" id="btnInitiateCheckout">InitiateCheckout</button>
        <button class="btn" id="btnLead">Lead</button>
      </div>
      <div class="row">
        <button class="btn" id="btnPurchase">Purchase</button>
        <button class="btn secondary" id="btnCustomActivation">自定义：Activation</button>
      </div>
    </section>

    <section class="card stack">
      <h3 style="margin:0;">事件参数（可选）</h3>
      <div class="row">
        <div>
          <label for="amount">金额（用于 Purchase）</label>
          <input id="amount" type="number" step="0.01" placeholder="例如 29.90" />
        </div>
        <div>
          <label for="ccy">币种</label>
          <select id="ccy">
            <option value="MYR" selected>MYR</option>
            <option value="USD">USD</option>
            <option value="SGD">SGD</option>
            <option value="THB">THB</option>
            <option value="VND">VND</option>
            <option value="IDR">IDR</option>
          </select>
        </div>
      </div>
    </section>

    <section class="card stack">
      <h3 style="margin:0;">Advanced Matching（可选）</h3>
      <div class="row">
        <div>
          <label for="em">邮箱 em</label>
          <input id="em" type="email" placeholder="name@example.com" />
        </div>
        <div>
          <label for="ph">手机号 ph（仅数字，含国家码）</label>
          <input id="ph" type="tel" inputmode="numeric" placeholder="60123456789" />
        </div>
      </div>
      <button class="btn" id="applyAM">应用高级匹配</button>
      <p class="footer">提示：这里传入未哈希的 em/ph，像素会自动做 SHA-256 再上报。</p>
    </section>

    <section class="card stack">
      <h3 style="margin:0;">其它常见事件</h3>
      <div class="row">
        <button class="btn secondary" id="btnContact">Contact</button>
        <button class="btn secondary" id="btnSubscribe">Subscribe</button>
      </div>
      <div class="row">
        <button class="btn secondary" id="btnSearch">Search</button>
        <button class="btn secondary" onclick="fire('CompleteRegistration')">CompleteRegistration</button>
      </div>
    </section>

    <section class="card stack">
      <h3 style="margin:0;">事件日志</h3>
      <div id="eventLog" class="log" aria-live="polite"></div>
      <div class="footer">在 Meta Events Manager 的「Test Events」里也能看到实时事件。</div>
    </section>

    <section class="card">
      <div class="footer">
        仅用于测试/验证像素触发。上线投放请确保隐私政策、Cookie 提示、同意管理等已到位；若需要服务端 <b>Conversions API</b> 去重与更稳的归因，这个页面可配合你们后端加 CAPI（用同一个 <code>eventID</code> 做去重）。
      </div>
    </section>
  </main>
</body>
</html>
